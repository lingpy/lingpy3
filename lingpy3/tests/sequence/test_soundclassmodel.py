# coding: utf8
from __future__ import unicode_literals, print_function, division
from collections import defaultdict

from mock import patch
from clldutils.testing import WithTempDir

from lingpy3.util import data_path
from lingpy3 import jsonlib


MATRIX_DISS = [
    [0, -100, -5, -100, -100, -100, -100, -100, -100, -100, -100, -100, -100, -100, -100,
     -100, -100, -100, -100, -100, -100, -100, -100, -100, -100, -100, -100, -100, -100],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-5, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0],
    [-100, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10, 0,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 10,
     0, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     10, 0],
    [-100, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
     0, 10]]


CONVERTER_ASJP = {
    '\u02a7': 'C',
    '\u2074\u2074': '5',
    '\u2074\u2075': '2',
    'ts': 'C',
    '\u223c': 'n',
    'b\u0361v': 'b',
    '\u0146': 'n',
    '\u025c': 'I',
    '\u02e7': '6',
    '\xeb': 'e',
    '\u026c': 'L',
    '\u2070': '6',
    't\u0361\u0282': 'C',
    't\u0361\u0283': 'C',
    '\xfb': 'u',
    'd\u0291': 'j',
    '\u0101': 'a',
    '\u2080': '6',
    '\u0207': 'e',
    '\u028c': 'o',
    '\u1e0f': 'd',
    '\u0111': '8',
    '\u0217': 'u',
    't\u0361\u0255': 'C',
    '+': '+',
    '\u0131': 'i',
    '\u03b2': 'b',
    'p\u0361f': 'p',
    'd\u035c\u0292': 'j',
    'd\u035c\u0291': 'j',
    'd\u035c\u0290': 'C',
    '\u2085\u2085': '5',
    '\u2085\u2084': '3',
    '\u2085\u2081': '3',
    '\u2085\u2083': '3',
    '\u2085\u2082': '3',
    '\u0257': 'd',
    '\u0161': 'S',
    '\xe0': 'a',
    '\u0267': 'S',
    '\u2074\xb9': '3',
    't\u0255\u02b0': 'C',
    'k': 'k',
    '\u2074\xb2': '3',
    'bv': 'b',
    '\xf0': '8',
    '\u0277': 'u',
    '\u207b': '6',
    'ts\u02b0': 'C',
    '\u2081': '6',
    '\u028d': 'w',
    '\u0256\u0290': 'j',
    '\u029d': 'S',
    'u': 'u',
    '\u03c7': 'G',
    't\u0361\u03b8': 'C',
    '\u0252': 'o',
    '\u045e': 'i',
    '\xe1': 'a',
    '\u0262': 'q',
    '\u1ee5': 'u',
    'f': 'f',
    '\u01eb': 'o',
    '\xf1': 'n',
    '\u0272': 'H',
    'v': 'v',
    '\u0180': 'v',
    '\u0282': 'S',
    '\u2086': '6',
    '\u0292': 'Z',
    '\u011b': 'e',
    '\u1e25': 'h',
    '\u012b': 'i',
    'd\u0361\u0290': 'j',
    'd\u0361\u0291': 'j',
    'd\u0361\u0292': 'j',
    '\u0e45': 'i',
    '\u014b': 'N',
    '\u01d0': 'i',
    '\u015b': 's',
    '\u0250\u032f': 'r',
    'a': 'a',
    '\xe6': 'E',
    '\u016b': 'u',
    '\u026d': 'L',
    'q': 'q',
    '\u01f0': 'j',
    '\u1e75': 'u',
    '\xf6': 'E',
    '\u027d': 'r',
    '\u028b': 'w',
    't\u0255': 'C',
    '\u1e93': 'z',
    'd\u035cz': 'j',
    '\xb7': '_',
    '\u0142': 'l',
    '\u2083\u2083': '4',
    '\u2083\u2082': '3',
    '\u2083\u2081': '3',
    '\u2083\u2085': '2',
    '\u2083\u2084': '2',
    '\u0250': 'a',
    '\u1e5b\u0301': 'r',
    '\u0152': 'E',
    '\u01dd': 'I',
    '\xe7': 'S',
    'l': 'l',
    '\u0270': 'w',
    '\u1ef3': 'i',
    '\u0280': 'r',
    't\u0361s': 'c',
    '\u010d': 'C',
    '\u0290': 'Z',
    'p': 'p',
    '\u222b': 'S',
    '\u012d': 'i',
    '\u1e33': 'k',
    't\u035c\u03b8': 'C',
    '\u1e43': 'm',
    '\u014d': 'o',
    '\u01d2': 'o',
    '\u025b': 'E',
    '\u015d': 'S',
    '\u1e63': 's',
    'g': 'g',
    '\u026b': 'l',
    '\u016d': 'u',
    '\xec': 'i',
    't\u035cs': 'j',
    '\u1e73': 'i',
    'w': 'w',
    '\u027b': 'L',
    '\xfc': 'i',
    '\u0281': 'G',
    '\u0291': 'Z',
    '\u02a1': 'G',
    '\xb2\xb2': '1',
    '\xb2\xb3': '2',
    '\xb2\xb9': '3',
    '\u0236': 't',
    '\u013c': 'l',
    '\u1fc3': 'n',
    't\u035c\u0255': 'C',
    '\u0256': 'd',
    'd\u0361z': 'c',
    'b': 'b',
    '\u0266': 'h',
    '\xed': 'i',
    'r': 'r',
    '\u0276': 'E',
    '\u1ef9': 'i',
    '\xfd': 'i',
    '\u017c': 'z',
    't\u035c\u0283': 'C',
    't\u035c\u0282': 'C',
    '\u1d50p': 'p',
    '\u2082': '6',
    '\u1d50b': 'b',
    '\u0221': 'd',
    '\u0127': 'G',
    '\u02a6': 'c',
    '\xb2': '6',
    '\u0435': 'e',
    '\u0241': '7',
    '\u0251': 'o',
    '\xb2\u2074': '2',
    '\u1ed1': 'o',
    '\xe2': 'a',
    '\u0167': 't',
    '\u02e6': '6',
    'm': 'm',
    '\u0271': 'm',
    '\xf2': 'o',
    '\u2083': '6',
    '\u2084\u2084': '5',
    '\u2084\u2085': '2',
    '\u2084\u2082': '3',
    '\u2084\u2083': '3',
    '\u028f': 'i',
    '\u2084\u2081': '3',
    '\u029f': 'L',
    '\u0430': 'a',
    '\xb3': '6',
    '\u03b5': 'E',
    '\u0234': 'L',
    '\u0440': 'p',
    '\u03c5': 'w',
    'dz': 'j',
    '\u0254': 'o',
    '\xe3': 'a',
    '\u0264': 'o',
    'h': 'h',
    '\xf3': 'o',
    '\u0274': 'N',
    'x': 'x',
    '\u017e': 'Z',
    '\u0284': 'C',
    '\u1e07': 'b',
    '\u0294': '7',
    '\u0119': 'e',
    '#': '_',
    '\u02a4': 'j',
    '\u0129': 'i',
    '\u022f': 'o',
    '\u1e37': 'l',
    '\u1e47': 'n',
    '\u01ce': 'a',
    '\u0159': 'r',
    '\u025f': 'C',
    'c': 'T',
    '\u25e6': '_',
    '\u0169': 'u',
    '\xe8': 'e',
    '\u026f': 'u',
    's': 's',
    '\xf8': 'e',
    '\u027f': 'i', u"'\u02b7": '7',
    '\u1d00': 'a',
    '\u0285': 'i',
    '\u0295': 'G',
    '\u02a5': 'j',
    '\u2082\u2082': '1',
    'pf': 'p',
    '\xb9': '6',
    '\u1ebd': 'e',
    'p\u035cf': 'p',
    '\u0148': 'n',
    '\u1ecd': 'o',
    '\u025a': 'I',
    '\u02e5': '6',
    '\xe9': 'e',
    '\u026a': 'i',
    'n': 'n',
    '\xf9': 'u',
    '\u027a': 'r',
    '\u0288\u0282\u02b0': 'C',
    '\u0103': 'a',
    '\u028a': 'u',
    '\u1e0d': 'd',
    '\u2074\xb3': '3',
    '\u0113': 'e',
    '\u1e2d': 'i',
    '\u0235': 'H',
    '\u2081\u2081': '1',
    '\u2081\u2083': '2',
    '\u2081\u2082': '2',
    '\u2081\u2085': '2',
    '\u2081\u2084': '2',
    '\u0288\u0282': 'C',
    '\u0153': 'E',
    '\u0255': 'S',
    '\u0163': 't',
    '\u0265': 'y',
    'i': 'i',
    '\u1e6d': 't',
    '\xee': 'i',
    '\u2c71': 'v',
    '\u0275': 'I',
    '\u1e7f': 'v',
    'y': 'i',
    '\u1e7d': 'v',
    '\xfe': '8',
    '\u0283': 'S',
    '\u2075\xb2': '3',
    '\u02a3': 'c',
    '\u0248': 'T',
    '\u1ecb': 'i',
    '\u0258': 'I',
    '\xdf': 's',
    '\u01e5': 'x',
    'd': 'd',
    '\u0268': 'I',
    '\xef': 'i',
    '\u1d72': 'r',
    '\u01f5': 'g',
    '\u2074': '6',
    '\u0278': 'f',
    '\u2084': '6',
    '\u0288': 't',
    '\u0213': 'r',
    '\u0115': 'e',
    '\u1e1b': 'e',
    '\u02a8': 'C',
    '\u0135': 'j',
    't': 't',
    '\u1e4b': 'n',
    '\u0253': 'b',
    '\u1e5b': 'r',
    '_': '_',
    '\u0263': 'x',
    '\xe4': 'a',
    '\u02e8': '6',
    'o': 'o',
    '\u0273': 'n',
    '\xf4': 'o',
    '\u2085': '6',
    '\u0289': 'I',
    '\u0299': 'b',
    '\u1d1c': 'u',
    '\u019f': '8',
    '\u1ea1': 'a',
    '\xb3\u2075': '2',
    '\xb3\u2074': '2',
    '\u0261': 'g',
    '\u0442': 't',
    '\u0144': 'n',
    '\xb2\u2075': '2',
    '\xb9\xb9': '1',
    '\xb9\xb3': '2',
    '\xb9\xb2': '2',
    '\u025e': 'u',
    '\xe5': 'a',
    '\u2075\u2075': '5',
    '\u2075\u2074': '3',
    'j': 'y',
    '\u026e': 'L',
    '\u0269': 'i',
    '\xf5': 'o',
    'z': 'z',
    '\u027e': 'r',
    '\u2082\u2084': '2',
    '\u2082\u2085': '2',
    '\u2082\u2081': '3',
    '\u1d07': 'E',
    '\u2082\u2083': '2',
    '\u028e': 'l',
    '\xb9\u2075': '2',
    '\xb9\u2074': '2',
    '\u1e21': 'g',
    '\u2075\xb9': '3',
    '\u2075\xb3': '3',
    '\u02ae': 'u',
    '\u03b8': '8',
    '\u014f': 'o',
    '\u01d4': 'u',
    '\u0259': 'I',
    '\xb3\xb9': '3',
    'e': 'e',
    '\xb3\xb3': '4',
    '\xb3\xb2': '3',
    '\xea': 'e',
    '\u1e71': 't',
    '\u2075': '6',
    '\u0279': 'r',
    '\xfa': 'u',
}


class Tests(WithTempDir):
    def test_SoundClassModel(self):
        from lingpy3.sequence.soundclassmodel import SoundClassModel

        with patch('lingpy3.sequence.soundclassmodel.Cache', dict):
            asjp = SoundClassModel.from_path(data_path('models', 'asjp'))
            assert list(asjp.converter.keys())[0] in asjp
            assert asjp[list(asjp.converter.keys())[0]]
            asjp('G', 'G')
            #self.assertAlmostEqual(asjp('G', 'G'), 10.0)
            self.assertEqual(asjp.converter, CONVERTER_ASJP)
            self.assertIn('asjp', repr(asjp))
            self.assertIn('asjp', '%s' % asjp)
            model = SoundClassModel.from_path(data_path('models', 'diss'))
            self.assertEqual(model.scorer.matrix, MATRIX_DISS)

            models = {name: SoundClassModel.from_name(name)
                      for name in ['sca', 'dolgo', 'art', 'color', 'asjp']}
            segments = set()
            for model in models.values():
                for segment in model.converter:
                    segments.add(segment)
            failures = defaultdict(list)
            for model in models.values():
                values = list(model.converter.keys())
                for segment in segments:
                    if segment not in values and segment != '-':
                        failures[model.name].append(segment)
            assert not failures

    def test_DiacriticsVowelsTones(self):
        from lingpy3.sequence.soundclassmodel import DiacriticsVowelsTones

        with patch('lingpy3.sequence.soundclassmodel.Cache', dict):
            DiacriticsVowelsTones.from_name('dvt')

        dvt = DiacriticsVowelsTones.from_name('dvt')
        self.assertEqual(
            dvt,
            jsonlib.load(
                jsonlib.dump(dvt, outdir=self.tmp_path()),
                cls=DiacriticsVowelsTones))
